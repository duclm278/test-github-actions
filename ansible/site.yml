---
- name: Set up Docker
  hosts: all
  become: true
  gather_facts: true
  roles:
    - common
  tags: [docker]

- name: Tear down existing services
  hosts: all
  become: false
  gather_facts: true
  roles:
    - cleanup
  tags: [cleanup]

- name: Deploy db
  hosts: all
  become: false
  gather_facts: false
  roles:
    - db
  tags: [deploy, db]

- name: Deploy backend
  hosts: all
  become: false
  gather_facts: false
  roles:
    - api
    - { role: lb, lb_service: "{{ api_lb_service }}" }
  tags: [deploy, api]

- name: Deploy frontend
  hosts: all
  become: false
  gather_facts: false
  roles:
    - web
    - { role: lb, lb_service: "{{ web_lb_service }}" }
  tags: [deploy, web]
